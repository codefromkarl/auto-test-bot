# Spec: NH-E2E-001 闹海完整创作流程端到端测试

## Purpose
验证闹海从创意到成品视频的完整创作流程的集成性和稳定性，确保各环节衔接顺畅，用户体验完整。覆盖从剧本创建、资源生产、分镜制作到最终视频导出的全链路。

## Scope
- **适用**：完整创作流程验证、多环节集成测试、端到端用户场景
- **核心流程**：对应 `docs/闹海关键流程.md` 中的 7 个关键步骤
- **包含**：
  1. 新建剧本与大纲
  2. 建立分集/角色/场景
  3. 分镜分析与制作
  4. 资源绑定
  5. 融图生成
  6. 视频制作
  7. 导出二创

## Preconditions
- 各独立模块功能已验证（NH-CREATE-001 到 NH-EXPORT-001 全部通过）
- 系统集成状态良好，关键服务（分析、生图、生视频）在线
- 端到端测试环境就绪（配置：`config/e2e_config.yaml`）
- 测试账号具有完整权限

## Procedure (Gates)

### 1) Gate-Env: 端到端环境就绪检查
**目的**: 确保完整创作流程测试环境可用
**检查项**:
- ✅ 核心服务健康检查 (Health Check)
- ✅ 必要的模型文件和预设资源已加载
- ✅ 数据库连接正常

### 2) Gate-Run: 执行完整创作流程 (Steps 1-7)

#### 步骤 1: 新建剧本，编写大纲
- **操作**: 创建新剧本，填写名称/说明。
- **关键参数**:
  - 画幅比例: 3:4 / 16:9 / 1:1
  - 风格: 选择预设画风
- **验证**: 剧本基础信息创建成功，封面上传成功。

#### 步骤 2: 建立剧本分集、角色、场景
- **操作**:
  - 创建分集结构。
  - 创建角色资产 (测试点: AI生成 & 图片上传)。
  - 创建场景资产 (测试点: AI生成 & 图片上传)。
- **验证**: 角色/场景库中资产状态可用，缩略图正常。

#### 步骤 3: 分集内容分析制作
- **操作**: 输入剧本文本，执行 AI 分析。
- **关键参数**: 目标时长 (1/3/5/10/30分钟)。
- **验证**:
  - AI 正确生成建议分镜数量。
  - 分镜脚本内容完整。
  - 脚本提示词 (Prompts) 已生成 (含人物/动作/场景)。

#### 步骤 4: 分镜资源绑定
- **操作**: 为每个分镜绑定角色 (Max 3) 和场景 (1)。
- **验证**: 绑定关系准确保存，UI 显示正确关联。

#### 步骤 5: 融图生成图片素材
- **操作**: 进入分镜，执行融合生图。
- **关键点**: 验证多张候选图片的生成与选择机制。
- **验证**: 生成的图片符合提示词描述，且正确融合了绑定的角色/场景特征。

#### 步骤 6: 图生视频制作
- **操作**: 将选定的图片素材转为视频。
- **关键参数**:
  - 模式: 图生视频 / 首尾帧视频
  - 分辨率: 1080P/4K
  - 数量: 1/2/4/8
- **验证**: 视频片段生成成功，播放正常，无明显花屏/崩坏。

#### 步骤 7: 视频导出二创
- **操作**: 批量下载素材或导出资源包。
- **验证**: 导出文件完整，可导入剪映进行二创 (模拟或手动验证)。

### 3) Gate-Judge: 判定标准
- **PASS**: 步骤 1-7 全程无阻塞报错，最终产出视频文件。
- **FAIL**: 任意步骤出现系统性错误 (5xx) 或功能阻塞 (流程无法继续)。
- **WARN**: 步骤成功但耗时过长或生成质量显著低于预期 (需人工复核)。

## Acceptance Criteria
- 必须产物：
  - `runs/YYYY-MM-DD/report.html` (测试报告)
  - `runs/YYYY-MM-DD/logs.txt` (执行日志)
  - `runs/YYYY-MM-DD/evidence/` (关键截图/生成素材)
- 成功标准：
  - 自动化脚本执行 exit code = 0
  - 关键路径覆盖率 100%

## Mapping

### Workflow 文件映射
| 测试场景 | 对应 Workflow 文件 | Robot Tag |
|---------|-------------------|-----------|
| 完整流程 (Golden Path) | `workflows/e2e/naohai_E2E_GoldenPath.yaml` | `@e2e @golden_path` |
| 快速冒烟 (Smoke) | `workflows/e2e/naohai_E2E_Smoke.yaml` | `@e2e @smoke` |

### Entry Point
```bash
# 执行完整端到端测试
python src/main_workflow.py --spec NH-E2E-001 --mode full

# 执行快速冒烟
python src/main_workflow.py --spec NH-E2E-001 --mode smoke
```

## Evidence Policy
- **Runs Directory**: `runs/YYYY-MM-DD/`
- **File Naming**: `NH-E2E-001-run.md`
- **Content**:
  - Execution Command
  - Environment Details (Local/CI, Commit SHA)
  - Step-by-step Result (Pass/Fail)
  - Deviations from Spec
  - Link to detailed logs/report

## ChangeLog
- 2025-12-20: 更新 - 对齐 `docs/闹海关键流程.md` (2025-12-18版)，细化 7 步流程细节。
- 2025-03-08: 初版 - 基于早期设计文档创建。

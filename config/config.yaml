# Auto Test Bot Configuration
# 测试机器人配置文件

test:
  # 测试流程名称
  flow_name: "nowhi_basic_navigation"

  # 测试目标网站
  url: "http://115.29.232.120/nowhi/index.html"

  # url: "http://localhost:9020/#/home/dashboard"

  # 超时设置 (毫秒)
  timeout: 30000

  # 页面加载超时
  page_load_timeout: 120000

  # 元素等待超时
  element_timeout: 10000

  # DOM 选择器配置
  selectors:
    # 提示词输入框
    prompt_input:
      - "#prompt-input"
      - "textarea[placeholder*='提示词']"
      - ".prompt-textarea"

    # 生成图片按钮
    generate_image_button:
      - "#generate-image-btn"
      - "button[data-action='generate-image']"
      - ".generate-btn:contains('生成图片')"

    # 生成视频按钮
    generate_video_button:
      - "#generate-video-btn"
      - "button[data-action='generate-video']"
      - ".generate-btn:contains('生成视频')"

    # 图片结果区域
    image_result:
      - ".image-result"
      - ".generated-image"
      - "[data-result='image']"

    # 视频结果区域
    video_result:
      - ".video-result"
      - ".generated-video"
      - "[data-result='video']"

    # 加载状态指示器
    loading_indicator:
      - ".loading"
      - ".spinner"
      - "[data-loading='true']"

# 工作流执行策略（用于避免“看起来卡住”与假阳性）
execution:
  # strict：任一非 optional 步骤失败→phase 失败（避免被后续成功步骤覆盖）
  # recover：以最后一个非 optional 步骤结果为准（支持“失败后恢复”语义）
  phase_success_mode: "strict"
  # true：非 optional 步骤失败后立即停止执行该 phase 剩余步骤（减少无意义等待）
  fail_fast: true
  # wait_for 最大等待上限（毫秒），即使 workflow 写了更大的 timeout 也会被裁剪
  max_wait_for_timeout_ms: 240000
  # 任一单步最大执行时长（毫秒）；超过即终止该步并判失败（用于“4分钟以上等待就终止”）
  max_step_duration_ms: 240000
  # 失败现场自动截图（best-effort）
  screenshot_on_error: true
  screenshots_dir: "screenshots/errors"
  # 任一阶段失败后停止该 workflow（避免前置失败还继续跑后续阶段造成“看起来卡住”）
  stop_on_phase_failure: true
  # 自动基线准备：每个 workflow 执行前确保 AI创作/剧本列表至少有 1 个剧本卡片（无则自动创建）
  auto_ensure_baseline: true
  ensure_baseline_min_story_cards: 1

# 失败边界定义 (Failure Boundaries)
failure_boundaries:
  # Critical级别：立即停止所有执行
  critical:
    - "service_unavailable"     # 本地服务不可用
    - "browser_crash"           # 浏览器崩溃
    - "config_invalid"           # 配置文件错误

  # High级别：重试3次后停止
  high:
    - "auth_failure"            # 认证失败
    - "workflow_file_not_found"  # 工作流文件缺失
    max_retries: 3
    retry_delay: 5  # 秒

  # Medium级别：继续执行后续用例
  medium:
    - "element_not_found"       # 页面元素缺失
    - "timeout_unexpected"      # 操作超时
    - "assertion_failed"        # 业务断言失败
    continue_on_failure: true

  # Low级别：记录但不影响执行
  low:
    - "report_generation_failed" # 报告生成失败
    - "file_write_error"        # 非关键文件写入失败
    log_only: true

# 测试步骤配置（重构版本）
steps:
  # 是否执行网站访问测试
  open_site: true

  # 是否执行导航到AI创作页
  navigate_to_ai_create: true

  # 是否执行导航到文生图页
  navigate_to_text_image: true

  # 是否执行文生图测试
  generate_image: true

  # 是否执行图生视频测试
  generate_video: true

  # 测试提示词
  test_prompt: "一只可爱的猫咪在花园里玩耍"

# 重试配置
retry:
  # 最大重试次数
  max_attempts: 3

  # 重试间隔 (秒)
  delay: 5

  # 哪些步骤需要重试
  retry_steps:
    - "open_site"
    - "generate_image"
    - "generate_video"

# 浏览器配置
browser:
  # 浏览器类型: chromium, firefox, webkit
  type: "chromium"
  # 登录状态
  storage_state: scripts/auth/auth_state_real.json
  # sessionStorage 登录态（token/user_info）
  session_state: scripts/auth/auth_session.json

  # 是否无头模式
  headless: false

  # 慢点击
  slow_mo: 100

  # 浏览器窗口大小
  viewport:
    width: 1920
    height: 1080

  # 用户代理
  user_agent: "AutoTestBot/1.0 (Playwright)"

  # 忽略 HTTPS 错误
  ignore_https_errors: true

# 日志配置
logging:
  # 日志级别: DEBUG, INFO, WARNING, ERROR, CRITICAL
  level: "INFO"

  # 日志格式
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

  # 日志文件路径
  file_path: "logs/test_bot.log"

  # 日志文件最大大小 (MB)
  max_file_size: 10

  # 保留的日志文件数量
  backup_count: 5

  # 是否输出到控制台
  console_output: true

# MCP 集成配置
mcp:
  # 是否启用 MCP
  enabled: true

  # 监控级别: basic, detailed, full
  monitoring_level: "detailed"

  # 控制台监控
  console:
    enabled: true
    capture_logs: true
    capture_warnings: true
    capture_errors: true

  # 网络监控
  network:
    enabled: true
    capture_requests: true
    capture_responses: true
    capture_headers: true
    capture_body: false  # 注意：捕获 body 会增加开销

  # 性能监控
  performance:
    enabled: true
    trace_duration: 30000  # 30秒

  # DOM 监控
  dom:
    enabled: true
    capture_snapshots: true
    snapshot_on_error: true

# 报告配置
reporting:
  # 报告输出目录
  output_dir: "reports"

  # 报告格式: json, html, both
  format: "both"

  # 是否包含截图
  include_screenshots: true

  # 是否包含 MCP trace 数据
  include_mcp_data: true

  # 是否启用优化格式（决策导向）
  use_optimized_format: true

  # 报告保留天数
  retention_days: 30

# 截图配置
screenshots:
  # 是否启用截图
  enabled: true

  # 截图格式: png, jpeg
  format: "png"

  # 截图质量 (jpeg only)
  quality: 80

  # 截图时机
  capture_on:
    - "step_start"
    - "step_success"
    - "step_failure"
    - "test_complete"

  # 截图保存路径
  save_path: "screenshots"

# 通知配置 (可选)
notifications:
  # 是否启用通知
  enabled: false

  # 通知方式: email, webhook, slack
  method: "webhook"

  # 通知条件
  notify_on:
    - "test_failure"
    - "api_errors"
    - "performance_degradation"

# =========================
# Phase 2/3/4 扩展配置（可选）
# =========================

# 插件系统（Phase 2）
plugins:
  # 插件目录（默认：src/plugins）
  dir: "src/plugins"

  # 启用的插件模块名（对应插件文件名，不含 .py）
  # 说明：PluginManager 会仅加载 enabled 列表中的模块，避免未启用插件导致加载失败
  enabled:
    - "async_task"
    - "file_processing"
    - "api_mixing"

  # 单个插件配置（键名与 enabled 模块名一致）
  file_processing:
    base_temp_dir: "temp"

# 监控系统（Phase 3）
monitoring:
  enabled: false

  metrics:
    # 可选：JSONL 持久化路径（用于基线对比/CI门禁）
    persist_path: "reports/metrics.jsonl"

  ingest:
    domains_by_event_prefix:
      "task.": "task"
      "file.": "file"
      "locator.": "locator"
    event_types:
      - "task.completed"
      - "task.failed"
      - "task.timeout"
      - "file.download_completed"
      - "file.processing_failed"
      - "locator.success"
      - "locator.failure"

  slo_definitions:
    async_task.completion_rate:
      type: "event_ratio"
      domain: "task"
      numerator_event: "task.completed"
      denominator_events: ["task.completed", "task.failed", "task.timeout"]
      min: 0.95

  alerts:
    notifier:
      # file/webhook
      type: "file"
      file:
        path: "reports/alerts.jsonl"
      webhook:
        url: ""

# Dashboard（Phase 3 Week7）
dashboard:
  enabled: false
  host: "127.0.0.1"
  port: 8081

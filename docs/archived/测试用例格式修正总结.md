# 闹海测试用例格式修正总结

## 问题概述

新创建的测试用例（FC-NH系列）存在以下格式问题，需要修正以符合现有的action类型和YAML格式。

## 1. 格式问题列表

### 1.1 不支持的Action类型
| 原Action类型 | 修正方法 | 说明 |
|-------------|---------|------|
| `assert_element_exists` | 替换为 `wait_for` + condition | 使用wait_for等待元素出现 |
| `assert_element_count` | 替换为 `wait_for` + selector | 等待多个元素出现 |
| `assert_element_selected` | 替换为 `wait_for` + selector | 等待特定选中状态 |
| `move_slider` | 替换为 `input` | 使用input输入值来控制滑块 |
| `save_data` | 删除或注释 | 该action不存在 |

### 1.2 不支持的YAML属性
| 原属性 | 修正方法 | 说明 |
|--------|---------|------|
| `type: "readonly/write"` | 删除 | workflow级别不支持 |
| `coverage_level: "L1/L2/L3"` | 删除 | workflow级别不支持 |
| `test_account: "专用测试账号"` | 删除 | workflow级别不支持 |
| `optional: true/false` | 改为注释 `# optional:` | YAML语法不支持 |

### 1.3 有效Action类型
以下action类型是支持的，可以正常使用：
- ✅ `open_page`
- ✅ `click`
- ✅ `input`
- ✅ `wait_for`
- ✅ `screenshot`
- ✅ `clear_input`
- ✅ `extract_video_info`
- ✅ `assert_logged_in`
- ✅ `upload_file`

## 2. 修正后的文件列表

所有新创建的测试用例都已创建修正版本（带`_fixed`后缀）：

1. **Step 1**
   - `naohai_FC_NH_002_story_card_display_fixed.yaml`
   - `naohai_FC_NH_003_story_card_menu_fixed.yaml`
   - `naohai_FC_NH_012_create_story_complete_fixed.yaml`

2. **Step 2**
   - `naohai_FC_NH_013_episode_management_fixed.yaml`
   - `naohai_FC_NH_018_character_management_fixed.yaml`
   - `naohai_FC_NH_022_scene_management_fixed.yaml`

3. **Step 3**
   - `naohai_FC_NH_026_storyboard_management_fixed.yaml`
   - `naohai_FC_NH_030_ai_script_analysis_fixed.yaml`

4. **Step 4**
   - `naohai_FC_NH_037_character_scene_binding_fixed.yaml`

5. **Step 5**
   - `naohai_FC_NH_039_image_material_fixed.yaml`

6. **Step 6**
   - `naohai_FC_NH_042_video_creation_fixed.yaml`

## 3. 主要修正原则

### 3.1 断言处理
```yaml
# 原格式（错误）
- action: "assert_element_exists"
  selector: ".element"
  optional: true

# 修正格式
- action: "wait_for"
  condition:
    selector: ".element"
    visible: true
  timeout: ${test.timeout.element_load}
```

### 3.2 可选步骤处理
```yaml
# 原格式（错误）
- action: "click"
  selector: ".element"
  optional: true

# 修正格式（使用注释说明）
- action: "click"
  selector: ".element"
  timeout: ${test.timeout.element_load}
  # optional: 如果元素不存在则跳过
```

### 3.3 复杂断言简化
```yaml
# 原格式（错误）
- action: "assert_element_count"
  selector: ".element"
  expected_count: 3

# 修正格式（等待第三个元素出现）
- action: "wait_for"
  condition:
    selector: ".element:nth-child(3)"
    visible: true
  timeout: ${test.timeout.element_load}
```

## 4. 建议执行方案

1. **使用修正版本**：执行所有`*_fixed.yaml`文件
2. **备份原文件**：保留原始文件作为参考
3. **测试验证**：先执行简单的冒烟测试验证格式正确性

## 5. 执行命令示例

```bash
# 执行修正后的测试用例
./venv/bin/python scripts/run_workflow_test.py --workflow workflows/naohai_FC_NH_002_story_card_display_fixed.yaml --config config/config.yaml

# 批量执行所有Step 1测试
for file in workflows/naohai_FC_NH_00*_fixed.yaml; do
    ./venv/bin/python scripts/run_workflow_test.py --workflow $file --config config/config.yaml
done
```

## 6. 注意事项

1. **超时设置**：所有等待操作都使用了`${test.timeout.element_load}`或`${test.timeout.page_load}`
2. **截图证据**：保留了所有截图步骤用于问题排查
3. **路径一致性**：所有截图保存在`screenshots/naohai/`目录下
4. **命名规范**：文件名保持与FC-NH编号对应，便于追踪
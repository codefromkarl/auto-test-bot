# 闹海当前版本测试用例文档（功能清单覆盖）- 更新版

更新时间：2025-12-16
范围来源：`docs/闹海当前版本功能清单及流程xlsx.xlsx`（Sheet：`功能清单`）
自动化载体：`workflows/at/*.yaml` + `workflows/fc/*.yaml`

## 0. 目的与范围

本文件将"功能清单"落为**可执行/可验收的测试用例**，并明确：

- 每个功能点对应的测试目标、前置条件、步骤与预期结果
- 已落地的自动化用例（workflow）与其覆盖范围
- 未落地/受阻用例的原因（例如：缺少稳定入口、需要测试数据、清单缺口）

说明：
- 本文档优先覆盖 **闹海当前版本（剧本/分集/分镜/视频创作）** 的功能清单。
- 自动化分两层：
  - **只读（A类）**：不创建/不删除业务数据，仅做页面到达 + 关键锚点断言 + 截图。
  - **写入（B类）**：会创建/编辑/删除数据，需在专用测试账号与隔离环境运行（本文档仅标注，后续再补齐）。

## 1. 测试环境与前置

- 目标站点：由 `config/config.yaml` 的 `test.url` 指定（当前为 `http://115.29.232.120/nowhi/index.html#/home/dashboard`）
- 登录态：
  - `scripts/auth/auth_state_real.json`（Playwright storage_state）
  - `scripts/auth/auth_session.json`（sessionStorage token/user_info）
  - 配置位置：`config/config.yaml:93`
- 执行入口：
  - `./venv/bin/python scripts/run_workflow_test.py --workflow <yaml> --config config/config.yaml`
  - 产物目录：`test_reports/<workflow_name>_*`、`screenshots/naohai/*.png`

## 2. 用例编号规范

- 自动化工作流用例：`AT-NH-###`（映射到一个 `workflows/at/*.yaml`）
- 功能清单覆盖用例：`FC-NH-###`（映射到 xlsx 的行号：例如 `FC-NH-004` 对应第 4 行）

覆盖等级（用于描述"只读用例"对功能点的覆盖深度）：
- `L0`：到达页面/模块（路由可达、核心容器存在）
- `L1`：存在性断言（关键按钮/输入/选项存在）
- `L2`：交互断言（点击/输入/切换产生可见变化，但不落库）
- `L3`：端到端（会触发创建/编辑/删除或真实生成能力，通常会落库/消耗资源）

## 3. 已落地自动化用例（AT-NH-001 ~ AT-NH-003）

> 说明：`AT-NH-002` 为写入型冒烟（会输入/可能产生数据），其余默认按"只读/弱交互"设计。

| 用例ID | workflow | 类型 | 覆盖等级 | 目标/断言摘要 |
|---|---|---|---|---|
| AT-NH-001 | `workflows/at/naohai_01_story_list_smoke.yaml` | 冒烟 | L0+L1 | 访问站点→已登录→进入 AI创作/剧本列表→截图 |
| AT-NH-002 | `workflows/at/naohai_02_create_story_smoke.yaml` | 冒烟（写入） | L2+L3 | 打开新建剧本弹窗→填写基础信息→进入"画风"步骤→截图 |
| AT-NH-003 | `workflows/at/naohai_03_storyboard_smoke.yaml` | 冒烟 | L0+L1 | 进入分镜管理页→截图 |

说明：原先 AT-NH-004 ~ AT-NH-013 的“只读/存在性”检查已统一迁移到 FC 目录，编号为 `FC-NH-051 ~ FC-NH-060`（见 `workflows/fc/FC_INDEX.md`）。

### 3.1 执行与验收标准（自动化）

- 每条 workflow 必须满足：
  - `report.json` 中 `summary.overall_success == true`
  - 对应截图落在 `screenshots/naohai/`（便于 UI 证据回溯）
- 报告路径规则：
  - `test_reports/<workflow_name>_YYYYMMDD_HHMMSS/report.json`
  - `test_reports/<workflow_name>_YYYYMMDD_HHMMSS/report.html`

## 4. 功能清单覆盖用例（FC-NH-002 ~ FC-NH-060）- 独立文件版本

说明：
- FC 用例目录：`workflows/fc/`
- 用例索引：`workflows/fc/FC_INDEX.md`

> 说明：
> - 本章节"步骤/预期"来自功能清单与流程整理，**每个FC-NH编号对应一个独立测试文件**
> - Step 2~6 的用例普遍依赖"已有剧本/分集/分镜"等测试数据；若环境为空数据，这些用例仅能作为验收脚本/待自动化清单。
> - 文件命名：`naohai_FC_NH_XXX.yaml`，其中XXX为三位数

### Step 1：剧本列表（FC-NH-002 ~ FC-NH-012）

#### FC-NH-002（1.1.1 剧本卡片展示）
- 功能点：剧本卡片展示（封面/标题/关键数值徽章/进度信息位）
- 前置条件（假设）：已登录；进入 AI创作/剧本列表；列表存在至少 1 个剧本卡片
- 操作步骤：进入剧本列表 → 观察卡片区域
- 预期结果：卡片展示封面/标题/关键信息位
- 自动化文件：`naohai_FC_NH_002.yaml`

#### FC-NH-003（1.1.2 剧本卡片菜单操作）
- 功能点：查看/项目说明/编辑(预留)/删除(二次确认)
- 前置条件（假设）：同 FC-NH-002；且卡片存在菜单入口
- 操作步骤：打开卡片菜单 → 逐项触发（查看/项目说明/删除）
- 预期结果：查看/说明可打开；删除需二次确认
- 自动化文件：`naohai_FC_NH_003.yaml`

#### FC-NH-012（1.3.3 提交创建）
- 功能点：创建剧本
- 前置条件（假设）：已完成基础信息与画风选择（假设）
- 操作步骤：点击"创建剧本/创建"按钮
- 预期结果：创建成功；返回列表出现新卡片或进入详情页（以实际为准）
- 自动化文件：`naohai_FC_NH_012.yaml`

### Step 2：新增分集 + 角色和场景（FC-NH-013 ~ FC-NH-025）- 独立文件版本

| 用例ID | 功能点 | 自动化文件 |
|---|---|---|
| FC-NH-013 | 新增分集入口 | `naohai_FC_NH_013.yaml` |
| FC-NH-014 | 新增分集字段 | `naohai_FC_NH_014.yaml` |
| FC-NH-015 | 新增分集提交 | `naohai_FC_NH_015.yaml` |
| FC-NH-016 | 分集卡片菜单 | `naohai_FC_NH_016.yaml` |
| FC-NH-017 | 分集统计弹窗 | `naohai_FC_NH_017.yaml` |
| FC-NH-018 | 角色创建方式单选 | `naohai_FC_NH_018.yaml` |
| FC-NH-019 | 角色模型选择 | `naohai_FC_NH_019.yaml` |
| FC-NH-020 | 角色卡片展示 | `naohai_FC_NH_020.yaml` |
| FC-NH-021 | 删除角色 | `naohai_FC_NH_021.yaml` |
| FC-NH-022 | 场景创建方式单选 | `naohai_FC_NH_022.yaml` |
| FC-NH-023 | 场景模型选择 | `naohai_FC_NH_023.yaml` |
| FC-NH-024 | 场景卡片展示 | `naohai_FC_NH_024.yaml` |
| FC-NH-025 | 删除场景 | `naohai_FC_NH_025.yaml` |

### Step 3：分镜管理（FC-NH-026 ~ FC-NH-036）- 独立文件版本

| 用例ID | 功能点 | 自动化文件 |
|---|---|---|
| FC-NH-026 | 新增分镜 | `naohai_FC_NH_026.yaml` |
| FC-NH-027 | 编辑分镜入口 | `naohai_FC_NH_027.yaml` |
| FC-NH-028 | 编辑提示词入口 | `naohai_FC_NH_028.yaml` |
| FC-NH-029 | 分镜删除入口 | `naohai_FC_NH_029.yaml` |
| FC-NH-030 | 剧本输入 | `naohai_FC_NH_030.yaml` |
| FC-NH-031 | 分析参数：目标时长 | `naohai_FC_NH_031.yaml` |
| FC-NH-032 | 建议分镜数量 | `naohai_FC_NH_032.yaml` |
| FC-NH-033 | 开始分析按钮 | `naohai_FC_NH_033.yaml` |
| FC-NH-034 | 分析产出 | `naohai_FC_NH_034.yaml` |
| FC-NH-035 | 提示词生成 | `naohai_FC_NH_035.yaml` |
| FC-NH-036 | 提示词展示与编辑 | `naohai_FC_NH_036.yaml` |

### Step 4：分镜绑定（FC-NH-037 ~ FC-NH-038）- 独立文件版本

| 用例ID | 功能点 | 自动化文件 |
|---|---|---|
| FC-NH-037 | 绑定多个角色 ≤3 | `naohai_FC_NH_037.yaml` |
| FC-NH-038 | 绑定 1 个场景 | `naohai_FC_NH_038.yaml` |

### Step 5：图片素材（FC-NH-039 ~ FC-NH-041）- 独立文件版本

| 用例ID | 功能点 | 自动化文件 |
|---|---|---|
| FC-NH-039 | 上传图片 | `naohai_FC_NH_039.yaml` |
| FC-NH-040 | 融合生图 | `naohai_FC_NH_040.yaml` |
| FC-NH-041 | 当前/历史 Tabs | `naohai_FC_NH_041.yaml` |

### Step 6：视频创作与项目级输出（FC-NH-042 ~ FC-NH-050）- 独立文件版本

| 用例ID | 功能点 | 自动化文件 |
|---|---|---|
| FC-NH-042 | 进入视频创作 | `naohai_FC_NH_042.yaml` |
| FC-NH-043 | 制作模式 | `naohai_FC_NH_043.yaml` |
| FC-NH-044 | 模型选择 | `naohai_FC_NH_044.yaml` |
| FC-NH-045 | 视频名称 | `naohai_FC_NH_045.yaml` |
| FC-NH-046 | 描述 | `naohai_FC_NH_046.yaml` |
| FC-NH-047 | 分辨率 | `naohai_FC_NH_047.yaml` |
| FC-NH-048 | 生成数量 | `naohai_FC_NH_048.yaml` |
| FC-NH-049 | 选择视频片段作为分镜视频 | `naohai_FC_NH_049.yaml` |
| FC-NH-050 | 导出资源包 | `naohai_FC_NH_050.yaml` |

## 5. 文件组织结构

```
workflows/
├── AT-NH系列（13个）
│   ├── naohai_01_story_list_smoke.yaml
│   ├── naohai_02_create_story_smoke.yaml
│   └── ... (至 naohai_13)
│
├── FC-NH系列（49个）
│   ├── Step 1（3个）
│   │   ├── naohai_FC_NH_002.yaml
│   │   ├── naohai_FC_NH_003.yaml
│   │   └── naohai_FC_NH_012.yaml
│   │
│   ├── Step 2（13个）
│   │   ├── naohai_FC_NH_013.yaml
│   │   ├── naohai_FC_NH_014.yaml
│   │   └── ... (至 naohai_FC_NH_025)
│   │
│   ├── Step 3（11个）
│   │   ├── naohai_FC_NH_026.yaml
│   │   ├── naohai_FC_NH_027.yaml
│   │   └── ... (至 naohai_FC_NH_036)
│   │
│   ├── Step 4（2个）
│   │   ├── naohai_FC_NH_037.yaml
│   │   └── naohai_FC_NH_038.yaml
│   │
│   ├── Step 5（3个）
│   │   ├── naohai_FC_NH_039.yaml
│   │   ├── naohai_FC_NH_040.yaml
│   │   └── naohai_FC_NH_041.yaml
│   │
│   └── Step 6（9个）
│       ├── naohai_FC_NH_042.yaml
│       ├── naohai_FC_NH_043.yaml
│       └── ... (至 naohai_FC_NH_050)
│
└── backup/
    └── 备份的原始文件
```

## 6. 批量执行命令示例

```bash
# 执行所有Step 1测试
for file in workflows/fc/naohai_FC_NH_00*.yaml; do
    echo "Running $file"
    ./venv/bin/python scripts/run_workflow_test.py --workflow $file --config config/config.yaml
done

# 执行特定功能测试
./venv/bin/python scripts/run_workflow_test.py --workflow workflows/fc/naohai_FC_NH_026.yaml --config config/config.yaml

# 并行执行多个只读测试
for file in workflows/fc/naohai_FC_NH_002.yaml workflows/fc/naohai_FC_NH_003.yaml workflows/fc/naohai_FC_NH_026.yaml; do
    ./venv/bin/python scripts/run_workflow_test.py --workflow $file --config config/config.yaml &
done

# 生成测试报告
./venv/bin/python scripts/generate_test_report.py --output-dir test_reports/$(date +%Y%m%d_%H%M%S)
```

## 7. 待补齐项（建议优先级）

P0（最影响端到端闭环）：
- FC-NH-012 创建剧本（L3 端到端写入）
- Step 2 分集/角色/场景创建（L3）
- Step 3 新增分镜 + AI分析剧本（L3，可能涉及较长耗时与失败重试）

P1（素材与产出）：
- Step 5 图片素材上传/融合生图（清单缺口需补充入口/限制/结果落位）
- Step 6 视频创作参数/生成/片段选用/导出（清单缺口需补充入口/带参规则）

## 8. CI/CD集成建议

```yaml
# .github/workflows/test-nahai.yml
name: Test Naohai Features
on:
  push:
    branches: [ main, develop ]
    paths:
      - 'workflows/at/*.yaml'
      - 'workflows/fc/*.yaml'
      - 'src/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'workflows/at/*.yaml'
      - 'workflows/fc/*.yaml'

jobs:
  test-at-nh:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        category: [smoke, readonly]
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run AT-NH tests
        if: matrix.category == 'smoke'
        run: |
          for file in workflows/at/*.yaml; do
            ./venv/bin/python scripts/run_workflow_test.py --workflow "$file" --config config/config.yaml
          done

      - name: Run FC-NH tests
        if: matrix.category == 'readonly'
        run: |
          for file in workflows/fc/*.yaml; do
            ./venv/bin/python scripts/run_workflow_test.py --workflow "$file" --config config/config.yaml
          done

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.category }}
          path: test_reports/
```

## 9. 注意事项

1. **执行环境**：只读测试可在任何环境执行；写入测试（L3）需在专用测试环境
2. **依赖管理**：确保测试数据准备充分，或使用测试账号的隔离数据
3. **超时设置**：视频生成等耗时操作建议设置合理超时（5-10分钟）
4. **失败处理**：失败截图自动保存，便于问题定位
5. **并发控制**：避免同时运行多个写入测试，防止数据冲突

name: Naohai Test Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点执行回归测试

env:
  PYTHON_VERSION: '3.9'

jobs:
  # 第一阶段：冒烟测试
  smoke:
    name: Smoke Tests (AT)
    runs-on: ubuntu-latest
    outputs:
      smoke-passed: ${{ steps.check.outputs.passed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run smoke tests
        id: run_smoke
        run: |
          echo "运行AT系列冒烟测试..."
          python scripts/run_workflows.py --type AT --parallel

      - name: Check smoke results
        id: check
        run: |
          if [ ${{ steps.run_smoke.outcome }} == 'success' ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload smoke reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: smoke-reports
          path: |
            test_reports/smoke_*/
            screenshots/naohai/*.png

  # 第二阶段：功能测试（依赖smoke通过）
  feature:
    name: Feature Tests (FC)
    runs-on: ubuntu-latest
    needs: smoke
    if: needs.smoke.outputs.smoke-passed == 'true'
    strategy:
      matrix:
        # 分批并行执行，避免资源冲突
        batch: [1, 2, 3]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run feature tests batch
        run: |
          echo "运行FC系列功能测试批次${{ matrix.batch }}..."
          python scripts/run_workflows.py --type FC --batch ${{ matrix.batch }} --parallel

      - name: Upload feature reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: feature-reports-batch-${{ matrix.batch }}
          path: |
            test_reports/fc_*/
            screenshots/naohai/*.png

  # 第三阶段：回归测试（定时或手动触发）
  regression:
    name: Regression Tests (RT)
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run regression tests
        run: |
          echo "运行RT系列回归测试..."
          python scripts/run_workflows.py --type RT --serial

      - name: Upload regression reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: regression-reports
          path: |
            test_reports/rt_*/
            screenshots/naohai/*.png

      - name: Generate regression summary
        if: always()
        run: |
          python scripts/generate_test_summary.py --type RT --output regression_summary.md

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('regression_summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # 汇总报告
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [smoke, feature]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download all reports
        uses: actions/download-artifact@v3

      - name: Generate comprehensive summary
        run: |
          echo "生成测试汇总报告..."
          python scripts/generate_test_summary.py --type ALL --output test_summary.md

      - name: Update test dashboard
        run: |
          # 更新测试看板
          python scripts/update_dashboard.py --input test_summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v3
        with:
          name: test-summary
          path: test_summary.md